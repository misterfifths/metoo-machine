#!/bin/bash

set -euo pipefail

cd "$(dirname "$0")"


TEMP_CONVERSION_DIR=sound
C_FILE=handset_sound_data.c
HEADER_FILE=handset_sound_data.h

AUDIO_FORMAT=pcm_u8
FILE_FORMAT=u8
EXTRA_FFMPEG_ARGS=
SAMPLE_RATE=16000
CHANNELS=2


echo ">> Cleaning up"
[ -d "$TEMP_CONVERSION_DIR" ] && rm -r "$TEMP_CONVERSION_DIR"
[ -f "$HEADER_FILE" ] && rm "$HEADER_FILE"
[ -f "$C_FILE" ] && rm "$C_FILE"


mkdir "$TEMP_CONVERSION_DIR"

echo -e "#pragma once\n" >> "$HEADER_FILE"

cat <<EOF | tee -a "$HEADER_FILE" "$C_FILE" > /dev/null
// This file is generated by the make_handset_header script.

// These are raw audio samples in $AUDIO_FORMAT format.
// Sample rate: $SAMPLE_RATE
// Channels: $CHANNELS

#include "sdkconfig.h"
#if CONFIG_TARGET_PHONE


EOF


for f in *.wav; do
    echo ">> Processing $f"

    output="$TEMP_CONVERSION_DIR/$(basename "$f" .wav)_samples"
    ffmpeg -loglevel error -i "$f" -acodec $AUDIO_FORMAT -ac $CHANNELS -ar $SAMPLE_RATE $EXTRA_FFMPEG_ARGS -f "$FILE_FORMAT" "$output"

    echo "// $f" >> "$C_FILE"
    xxd -i "$output" | sed 's/^unsigned/const unsigned/' | sed 's/ sound_/ /' >> "$C_FILE"
    echo -e "\n" >> "$C_FILE"
done


echo ">> Generating header"
cat "$C_FILE" | perl -ne '/(const unsigned (char|int) .*) =/ && print "extern $1;\n"' >> "$HEADER_FILE"


cat <<EOF | tee -a "$HEADER_FILE" "$C_FILE" > /dev/null


#endif
EOF



echo ">> Cleaning up"
rm -r "$TEMP_CONVERSION_DIR"


echo
echo "üëç  All done!"
echo "Results are in $C_FILE and $HEADER_FILE"