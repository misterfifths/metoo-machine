#!/bin/bash

set -euo pipefail

cd "$(dirname "$0")"


TEMP_CONVERSION_DIR=sound
HEADER_FILE=sound_data.h

AUDIO_FORMAT=pcm_u16le
SAMPLE_RATE=16000
CHANNELS=1


echo ">> Cleaning up"
[ -d "$TEMP_CONVERSION_DIR" ] && rm -r "$TEMP_CONVERSION_DIR"
[ -f "$HEADER_FILE" ] && rm "$HEADER_FILE"


mkdir "$TEMP_CONVERSION_DIR"

echo -e "#pragma once\n" >> "$HEADER_FILE"

echo -e "// This file is generated by tools/make_audio_header.\n" >> "$HEADER_FILE"
echo "// These are raw audio samples in $AUDIO_FORMAT format." >> "$HEADER_FILE"
echo "// Sample rate: $SAMPLE_RATE" >> "$HEADER_FILE"
echo -e "// Channels: $CHANNELS\n\n" >> "$HEADER_FILE"


for f in *.wav; do
    echo ">> Processing $f"

    output="$TEMP_CONVERSION_DIR/$(basename "$f" .wav)_samples"
    ffmpeg -loglevel error -i "$f" -acodec $AUDIO_FORMAT -ac $CHANNELS -ar $SAMPLE_RATE -map 0:a -f data "$output"

    echo "// $f" >> "$HEADER_FILE"
    xxd -i "$output" | sed 's/^unsigned/const unsigned/' >> "$HEADER_FILE"
    echo -e "\n" >> "$HEADER_FILE"
done


echo ">> Cleaning up"
rm -r "$TEMP_CONVERSION_DIR"


echo
echo "üëç  All done!"
echo "Result is in $HEADER_FILE"